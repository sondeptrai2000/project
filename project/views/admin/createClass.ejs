<!DOCTYPE html>
<html lang="en">

<head>
    <script src="/jquery/jquery.js"></script>
</head>

<body>
    <div id="tieude">
        <p>bảng lộ trình tùy biến</p>
    </div>
    <table border="solid">
        <tbody id="routeTuyBien"> </tbody>
        <tr id='trss'></tr>
    </table>
    <form method="post" action="/admin/createClass">
        <p>Create class</p>
        <label>Chọn lộ trình học</label>
        <select id="routeTypeS" name="routeName" onchange="routeType()">
                        <% targetxxx.forEach(function(targetxxx) { %>
                <option value="<%= targetxxx.routeName %>"><%= targetxxx.routeName %></option>
                <% }); %>
              </select>
        <br>
        <label for="level">Level</label>
        <select id="levelS" name="stage" onchange="level()"></select>
        <br>
        <label>Subject</label>
        <select id="subject" name="subject" onchange="getStudent()"></select>
        <br>
        <label for="topic">Class Name</label>
        <input type="text" name="className">
        <br>
        <label for="topic">Description</label>
        <input type="text" name="description">
        <br>
        <label for="topic">Total slot</label>
        <input type="number" name="totalSlot" onchange="totalSlot()">
        <br>
        <label for="topic">Student</label>

        <table id="studentTable" border='solid' style="display: none;">
            <thead>
                <tr>
                    <th><input id="myInputxxxx" type="text" placeholder="Search.."></th>
                </tr>
                <tr>
                    <th>avatar</th>
                    <th>username</th>
                    <th>routeName</th>
                    <th>stage</th>
                    <th>Chose</th>
                    <th>More information</th>
                </tr>
            </thead>
            <tbody class='taskrow'></tbody>
        </table>
        <label for="topic">Teacher</label>
        <select name="facultyID">
          <% teacher.forEach(function(teacher) { %>
            <option value="<%= teacher._id %>" ><%= teacher.username %> </option>
          <% }); %>
        </select>
        <br>
        <label for="topic">endDate</label>
        <input type="date" name="endDate">
        <br>
        <label for="topic">startDate</label>
        <input type="date" name="startDate">
        <!-- {{!-- tìm cách tạo lịch r tạo sự kiện chọn ngày giờ từ lịch r ms lưu vào db --}} -->
        <!-- {{!-- <br>
        <label for="topic">Schedule</label>
        <input type="date" name="Schedule"> 
        --}}  -->
        <br>
        <button type="submit" class="btn5">Submit</button>
    </form>
</body>
<script>
    function routeType() {
        var routeName = $('#routeTypeS').val();
        $.ajax({
            url: '/admin/getStage',
            method: 'get',
            dataType: 'json',
            data: {
                abc: routeName
            },
            success: function(response) {
                $('#tieude').html('');
                $('#routeTuyBien').html('');
                $('#trss').html('');

                if (response.msg == 'success') {
                    $('#levelS').html('');
                    $.each(response.data, function(index, data) {
                        $.each(data.routeSchedual, function(index, routeSchedual) {
                            var update = "<option value=" + routeSchedual.stage + ">" + routeSchedual.stage + "</option>"
                            $("#levelS").append(update);
                        });
                    });
                    $.each(response.targetxxx, function(index, targetxxx) {
                        $("#tieude").append("<p>Lộ trình:" + targetxxx.routeName + "</p><p>Miêu tả:" + targetxxx.description + "</p>");
                        $.each(targetxxx.routeSchedual, function(index, routeSchedual) {
                            $("#routeTuyBien").append("<th>Stage: " + routeSchedual.stage + "</th>");
                        });
                        $.each(targetxxx.routeSchedual, function(index, routeSchedual) {
                            $("#trss").append("<td id='lol" + index + "'></td>");
                            $.each(routeSchedual.routeabcd, function(indexx, routeabcd) {
                                var y = '#lol' + index
                                $(y).append("<li>" + routeabcd + "</li>");
                            });
                        });
                    });

                }
            },
            error: function(response) {
                alert('server error');
            }
        })
    }

    function level() {
        var routeName = $('#routeTypeS').val();
        var levelS = $('#levelS').val();
        $.ajax({
            url: '/admin/getStage',
            method: 'get',
            dataType: 'json',
            data: {
                abc: routeName,
                levelS: levelS,
            },
            success: function(response) {
                if (response.msg == 'success') {
                    $('#subject').html('');
                    $('.taskrow').html('');
                    $('#studentTable').show();
                    $.each(response.data, function(index, data) {
                        $.each(data.routeSchedual, function(index, routeSchedual) {
                            if (routeSchedual.stage == levelS) {
                                $.each(routeSchedual.routeabcd, function(index, routeabcd) {
                                    var update = "<option value=" + routeabcd + ">" + routeabcd + "</option>"
                                    $("#subject").append(update);
                                });
                            }
                        });
                    });
                }
            },
            error: function(response) {
                alert('server error');
            }
        })
    }

    function getStudent() {
        var routeName = $('#routeTypeS').val();
        var levelS = $('#levelS').val();
        $.ajax({
            url: '/admin/getStudent',
            method: 'get',
            dataType: 'json',
            data: {
                abc: routeName,
                levelS: levelS,
            },
            success: function(response) {
                if (response.msg == 'success') {
                    if (response.student.length == 0) {
                        $('.taskrow').html('');
                    } else {
                        $('.taskrow').html('');
                        $('#studentTable').show();
                        $.each(response.student, function(index, student) {
                            if (!student.subject.includes($("#subject").val())) {
                                $(".taskrow").append("<tr><td><img style ='max-width:150px;max-height:200px' src='" + student.avatar + "'></td><td>" + student.username + "</td><td>" + student.routeName + "</td><td>" + student.stage + "</td><td><input type='checkbox' name='hobby' value='" + student._id + "' /></td><td>" + "<button class='del' value='" + student._id + "'>View</button>" + "</td></tr>");
                            }
                        });
                    }
                }
            },
            error: function(response) {
                alert('server error');
            }
        })
    }
</script>

</html>